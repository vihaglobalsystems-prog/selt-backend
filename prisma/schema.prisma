generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email            String         @unique @db.VarChar(255)
  name             String         @db.VarChar(255)
  passwordHash     String?        @map("password_hash") @db.VarChar(255)
  googleId         String?        @map("google_id") @db.VarChar(255)
  avatarUrl        String?        @map("avatar_url")
  stripeCustomerId String?        @unique @map("stripe_customer_id") @db.VarChar(255)
  role             String?        @default("user") @db.VarChar(20)
  createdAt        DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime?      @default(now()) @map("updated_at") @db.Timestamptz(6)
  emailLogs        EmailLog[]
  payments         Payment[]
  subscriptions    Subscription[]
  testResults      TestResult[]
  userProfile      UserProfile?

  @@index([email], map: "idx_users_email")
  @@index([googleId], map: "idx_users_google_id")
  @@index([stripeCustomerId], map: "idx_users_stripe_customer")
  @@map("users")
}

model Subscription {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String?   @map("user_id") @db.Uuid
  stripeSubscriptionId String    @unique @map("stripe_subscription_id") @db.VarChar(255)
  stripePriceId        String    @map("stripe_price_id") @db.VarChar(255)
  status               String    @db.VarChar(50)
  currentPeriodStart   DateTime? @map("current_period_start") @db.Timestamptz(6)
  currentPeriodEnd     DateTime? @map("current_period_end") @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean?  @default(false) @map("cancel_at_period_end")
  canceledAt           DateTime? @map("canceled_at") @db.Timestamptz(6)
  createdAt            DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  payments             Payment[]
  user                 User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([userId], map: "idx_subs_user")
  @@index([status], map: "idx_subs_status")
  @@index([currentPeriodEnd], map: "idx_subs_period_end")
  @@map("subscriptions")
}

model Payment {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String?       @map("user_id") @db.Uuid
  subscriptionId      String?       @map("subscription_id") @db.Uuid
  stripeInvoiceId     String?       @unique @map("stripe_invoice_id") @db.VarChar(255)
  stripePaymentIntent String?       @map("stripe_payment_intent") @db.VarChar(255)
  amount              Int
  currency            String?       @default("gbp") @db.VarChar(3)
  status              String        @db.VarChar(50)
  paidAt              DateTime?     @map("paid_at") @db.Timestamptz(6)
  createdAt           DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  subscription        Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user                User?         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  refunds             Refund[]

  @@index([userId], map: "idx_payments_user")
  @@index([subscriptionId], map: "idx_payments_subscription")
  @@map("payments")
}

model Refund {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentId      String?   @map("payment_id") @db.Uuid
  stripeRefundId String?   @unique @map("stripe_refund_id") @db.VarChar(255)
  amount         Int
  reason         String?   @db.VarChar(255)
  status         String    @db.VarChar(50)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  payment        Payment?  @relation(fields: [paymentId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([paymentId], map: "idx_refunds_payment")
  @@map("refunds")
}

model EmailLog {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  emailType String    @map("email_type") @db.VarChar(100)
  sentAt    DateTime? @default(now()) @map("sent_at") @db.Timestamptz(6)
  metadata  Json?
  user      User?     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([userId, emailType], map: "idx_email_log_user")
  @@map("email_log")
}

model TestResult {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?   @map("user_id") @db.Uuid
  email     String    @db.VarChar(255)
  testId    String?   @map("test_id") @db.VarChar(255)
  level     String?   @db.VarChar(10)
  score     Int?
  total     Int?
  percentage Decimal? @db.Decimal(5, 2)
  section   String?   @db.VarChar(50)
  timestamp DateTime? @default(now()) @db.Timestamptz(6)
  data      Json?
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([email], map: "idx_test_results_email")
  @@index([userId], map: "idx_test_results_user")
  @@map("test_results")
}

model UserProfile {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String    @unique @db.VarChar(255)
  userId    String?   @unique @map("user_id") @db.Uuid
  profile   Json      @default("{}")
  updatedAt DateTime? @default(now()) @map("updated_at") @db.Timestamptz(6)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([email], map: "idx_user_profiles_email")
  @@map("user_profiles")
}
